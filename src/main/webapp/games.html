<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320;" />
		<style>
			li { list-style-type:none; }
		</style>
		<!--link media="screen" rel="stylesheet" href="css/facebox.css" /-->
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="js/jquery.atmosphere-0.7.js"></script>
		<script type="text/javascript" src="js/jquery.predictem.js"></script>
		<script type="text/javascript" src="js/knockout-1.1.1.js"></script>
		<script type="text/javascript">
			var viewModel = {
				gameToCreate: {
					name: ko.observable(""),
					description: ko.observable(""),
					category: ""
				},
				games: ko.observableArray([])
			};
			
			// Model event handlers
			viewModel.addGame = function(game) {
				viewModel.games.push(game);
			};
			viewModel.joinGame = function(game) {
				location.href = "game.html#" + game.id;
			};
			
			function display(game) {
				// Initialize the game template and set the attributes and click handler
				$("#game-template")
					.tmpl({ game: game })
					//.hide()
					.prependTo("#games")
					//.slideToggle()
					.find("#join").click(function() {
						location.href = "game.html#" + $(this).closest("li").attr("id");
					});
			}
			
			$(document).ready(function() {
				if (location.href.indexOf("#") != -1) {
					//$("#gamesList").data("bind", { template: { name: "gameTemplate", foreach: viewModel.games }});
					//$("#gameJoinButton").data("bind", { click: function() { viewModel.joinGame() }});

					// Model event binding
					ko.bind("gamesList", { template: { name: "gameTemplate", foreach: viewModel.games }});
					ko.bind("gameJoinButton", { click: function() { viewModel.joinGame(this); }});
					
					// Bind the model and the view
					ko.applyBindings(viewModel);
					
			        // Get the category from the supplied hashtag
			    	var category = location.href.substr(location.href.indexOf("#") + 1);
			        
			        // Load the most recently created games
			        $.getJSON("rs/games/" + category + "/list/0/10", function(games) {
			        	viewModel.games(games);
          				//$.each(games.reverse(), function(i, game) {
          					//display(game);
          					//viewModel.addGames(game);
          				//});
        			});
				
					// Subscribe to the atmosphere lobby broadcaster
					$.predictem.subscribe("rs/games/" + category + "/subscribe", {
						received: display,
						published: function(game) {
							//location.href = "game.html#" + game.id;
						}});
				
					// Click handler to create games
					$("#game #create").click(function() {
						if (confirm("Are you sure?")) {
							$.predictem.publish("rs/games/" + category + "/create",
									{ category: category, name: $("#game #name").val(), description: $("#game #description").val() });
							
							// Clear the input values
							$("#game #name").val("");
							$("#game #description").val("");
						}
					});
				}
			});
		</script>
		<script id="gameTemplate" type="text/html">
			<li style="border:1px solid black;">
				<div style="display:table-cell; width:100%;">
					<div>${ name }</div>
					<div>${ description }</div>
				</div>
				<div style="display:table-cell; vertical-align:middle;">
					<button id="gameJoinButton" data-bind="">Join</button>
				</div>
			</li>
		</script>
	</head>
	<body>
		<div style="align:center; margin:0px auto; width:90%;">
			<ul style="border:1px solid blue; padding:0px; text-align:left;">
				<li><input style="width:100%;" type="text" placeholder="Name">
				<li><textarea style="width:100%;" placeholder="Description"></textarea>
				<li><input style="width:100%;" type="button" value="Create">
			</ul>
		</div>
		<div style="align:center; margin:0px auto; width:90%;">
			<ul style="border:1px solid red; padding:0px; text-align:left;" id="gamesList" data-bind></ul>
		</div>
	</body>
</html>