<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320;" />
		<!--link media="screen" rel="stylesheet" href="css/facebox.css" /-->
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="js/jquery.atmosphere-0.7.js"></script>
		<script type="text/javascript" src="js/jquery.predictem.js"></script>
		<script type="text/javascript">
			function display(question) {
				// Clone the game template and set the attributes and click handler
				$("#question-template")
					.tmpl({ question: question })
					.prependTo("#questions")
					.find("#join").click(function() {
						alert($(this).parent().attr("id")); });
			}
			
			$(document).ready(function() {
				if (location.href.indexOf("#") != -1) {
			        // Get the game id from the supplied hashtag
			    	var gameId = location.href.substr(location.href.indexOf("#") + 1);
			        
			        // Load the game questions
			        $.getJSON("rs/game/" + gameId + "/questions", function(games) {
          				$.each(questions.reverse(), function(i, question) {
          					display(question);
          				});
        			});
				
					// Subscribe to the atmosphere game broadcaster
					$.predictem.subscribe("rs/game/" + gameId + "/subscribe", {
						received: function(question) { display(question); }});

					// Click handlers for questions and choices
					$("#question-add").click(function() {
						if (confirm("Are you sure?")) {
							var question = {
									gameId: gameId,
									description: $("#question-add-description").val(),
									choices: []
							};
							$("input[name=choice-description]").each(function(i, choice) {
								question.choices[i] = $(choice).val();
							});
							alert(JSON.stringify(question));
							
							//$.predictem.publish("rs/game/" + gameId + "/question/create", question);
							
							// Clear the input values
							$("#game-add-description").val("");
						}
					});
					
					$("#choice-add").click(function() {
						$("#choice-added-template")
							.tmpl({ choice: { description: $("#choice-add-description").val() }})
							.prependTo("#choices")
							.find("#choice-delete").click(function() {
								$(this).parent().remove();
							});
						// clear the input values
						$("#choice-add-description").val("");
					});
				}
			});
		</script>
		<script id="question-template" type="text/x-jquery-tmpl">
			<div id="{{= question.id}}">
				<input type="radio" name="choices" value="{{= choice.description}}">{{= choice.description}}
			</div>
		</script>
		<script id="choice-added-template" type="text/x-jquery-tmpl">
			<div id="choice">
				<input name="choice-description" type="input" enabled="false" value="{{= choice.description}}">
				<input id="choice-delete" type="button" value="-">
			</div>
		</script>
	</head>
	<body>
		<div id="question">
			<input id="question-add-description" type="text">?
			<input id="question-add" type="button" value="Create">
			<div>
				<input id="choice-add-description" type="text" placeholder="Choice">
				<input id="choice-add" type="button" value="+">
			</div>
			<div id="choices">
			</div>
		</div>
		<div id="questions">
		</div>
	</body>
</html>