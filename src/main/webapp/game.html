<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320;" />
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="js/jquery.atmosphere-0.7.js"></script>
		<script type="text/javascript" src="js/jquery.predictem.js"></script>
		<script type="text/javascript">
			function refresh(question) {
				// Update the question and move it to the top of the list
				var questionDiv = $("#" + question.id);
				questionDiv.prependTo("#questions");
			}
			
			function received(question) {
				// Refresh the question if it already exists, which means it has been answered
				if($("#" + question.id).exists())
					return refresh(question);
				
				// Initialize the question template and set the attributes and click handlers
				var questionTemplate = $("#question-template").tmpl({ question: question });
				questionTemplate.prependTo("#questions");
				
				// Update 
				$.each(questionTemplate.find(":radio"), function(i, radio) {
					var choiceRadio = $(radio);
					choiceRadio.attr("disabled", true);
					
					if (!question.answered) {
						choiceRadio.click(function() {
							// Click handler that submits a guess when a radio button is selected
							$.question.guess(question, i, {
								success: function() {} });
						});
						choiceRadio.attr("disabled", false);
					}
				});
				// If a guess has been made check the corresponding radio button
				if (question.guess)
					$(":radio:nth(" + question.guess.choice + ")").attr("checked","checked");
				
				$.each(questionTemplate.find(":button"), function(i, button) {
					var answerButton = $(button);
					answerButton.hide();
					
					if (!question.answered && question.answerable) {
						answerButton.click(function() {
							// Click handler that submits the answer for the corresponding choice
							$.question.answer(question, i, {
								success: function() {} });
						});
						answerButton.show();
					}
				});
			}
			
			$(document).ready(function() {
				// TODO Check that aid cookie exists otherwise redirect to login
				if (location.href.indexOf("#") != -1) {
			        // Get the game id from the supplied hashtag
			    	var game = location.href.substr(location.href.indexOf("#") + 1);
			        
			       // TODO Load the game statistics and questions
			        $.getJSON("rs/game/" + game + "/questions/" + $.cookie("aid"), function(questions) {
          				$.each(questions.reverse(), function(i, question) {
          					received(question);
          				});
          				
    					// Subscribe to the atmosphere game broadcaster
    					$.predictem.subscribe("rs/game/" + game + "/subscribe", {
    						received: function(question) { received(question); }});
        			});

					// Click handlers for adding questions and choices
					$("#question-add").click(function() {
						if (confirm("Are you sure?")) {
							$.question.create($("#question"), game, {
								success: function() { alert("Question was successfully posed"); },
								error: function() { alert("There was an error with the submission of your question")} });
							
							// Clear the input values
							$("#question-add-description").val("");
							$("#choices").empty();
						}
					});
					
					$("#choice-add").click(function() {
						$("#choice-added-template")
							.tmpl({ choice: { description: $("#choice-add-description").val() }})
							.prependTo("#choices")
							.find("#choice-delete").click(function() {
								$(this).parent().remove();
							});
						// clear the input values
						$("#choice-add-description").val("");
					});
				}
			});
		</script>
		<script id="question-template" type="text/x-jquery-tmpl">
			<div id="{{= question.id}}">
				<div id="choices"></div>
				{{= question.description}}
				{{each(i, choice) question.choices}}
					<input type="radio" name="{{= question.id}}">{{= choice}}
					<input type="button" value="Answer">
				{{/each}}
			</div>
		</script>
		<script id="choice-added-template" type="text/x-jquery-tmpl">
			<div id="choice">
				<input name="choice-description" type="input" enabled="false" value="{{= choice.description}}">
				<input id="choice-delete" type="button" value="-">
			</div>
		</script>
	</head>
	<body>
		<div id="question">
			<input id="question-add-description" type="text">?
			<input id="question-add" type="button" value="Create">
			<div>
				<input id="choice-add-description" type="text" placeholder="Choice">
				<input id="choice-add" type="button" value="+">
			</div>
			<div id="choices">
			</div>
		</div>
		<div id="questions">
		</div>
	</body>
</html>