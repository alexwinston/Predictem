<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=320;" />
		<!--link media="screen" rel="stylesheet" href="css/facebox.css" /-->
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
		<script type="text/javascript" src="js/jquery.atmosphere-0.7.js"></script>
		<script type="text/javascript" src="js/jquery.predictem.js"></script>
		<script type="text/javascript">
			function display(question) {
				// Initialize the question template and set the attributes and click handlers
				$("#question-template")
					.tmpl({ question: question })
					.prependTo("#questions")
					.find(":radio").click(function() {
						$.question.guess(question, this, {
							success: function() {} }) });
			}
			
			$(document).ready(function() {
				if (location.href.indexOf("#") != -1) {
			        // Get the game id from the supplied hashtag
			    	var game = location.href.substr(location.href.indexOf("#") + 1);
			        
			       // TODO Load the game statistics and questions
			        $.getJSON("rs/game/" + game + "/questions", function(questions) {
          				$.each(questions.reverse(), function(i, question) {
          					display(question);
          				});
          				
          				// Load the player guesses
    			        $.getJSON("rs/game/" + game + "/guesses", function(guesses) {
    			        	$.each(guesses, function(i, guess) {
    			        		$("#" + guess.questionId + " :radio:nth(" + guess.choice + ")").attr("checked","checked");
    			        	})
            			});
        			});

					// Subscribe to the atmosphere game broadcaster
					$.predictem.subscribe("rs/game/" + game + "/subscribe", {
						received: function(question) { display(question); }});

					// Click handlers for questions and choices
					$("#question-add").click(function() {
						if (confirm("Are you sure?")) {
							$.question.create($("#question"), game, {
								success: function() { alert("Question was successfully posed"); },
								error: function() { alert("There was an error with the submission of your question")} });
							
							// Clear the input values
							$("#question-add-description").val("");
							$("#choices").empty();
						}
					});
					
					$("#choice-add").click(function() {
						$("#choice-added-template")
							.tmpl({ choice: { description: $("#choice-add-description").val() }})
							.prependTo("#choices")
							.find("#choice-delete").click(function() {
								$(this).parent().remove();
							});
						// clear the input values
						$("#choice-add-description").val("");
					});
				}
			});
		</script>
		<script id="question-template" type="text/x-jquery-tmpl">
			<div id="{{= question.id}}">
				{{= question.description}}
				{{each(i, choice) question.choices}}
				<input type="radio" name="{{= question.id}}" value="{{= i}}">{{= choice}}
				{{/each}}
			</div>
		</script>
		<script id="choice-added-template" type="text/x-jquery-tmpl">
			<div id="choice">
				<input name="choice-description" type="input" enabled="false" value="{{= choice.description}}">
				<input id="choice-delete" type="button" value="-">
			</div>
		</script>
	</head>
	<body>
		<div id="question">
			<input id="question-add-description" type="text">?
			<input id="question-add" type="button" value="Create">
			<div>
				<input id="choice-add-description" type="text" placeholder="Choice">
				<input id="choice-add" type="button" value="+">
			</div>
			<div id="choices">
			</div>
		</div>
		<div id="questions">
		</div>
	</body>
</html>